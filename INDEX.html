<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×§×•×“×§×¡ ××•× ×—×™ ××©×—×§×™ ×ª×¤×§×™×“×™×</title>
    
    <!-- ×˜×¢×™× ×ª Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- ×˜×¢×™× ×ª ×¤×•× ×˜ ALEF ×•-Inter (×›×—×œ×•×¤×”) -->
    <link href="https://fonts.googleapis.com/css2?family=Alef:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* ×”×’×“×¨×ª ×”×¤×•× ×˜ ×”×¨××©×™ - ×××œ×¦×ª ×©×™××•×© ×‘-Alef */
        body {
            font-family: 'Alef', Inter, sans-serif;
            direction: rtl;
            text-align: right;
        }
        /* ×’×œ×™×œ×” ×•×ª×¦×•×’×” ×œ××•×“×œ - ×¡×’× ×•×Ÿ ××’×™×œ×” */
        .modal-content {
            max-height: 80vh;
            overflow-y: auto;
            /* ×¡×’× ×•×Ÿ ××’×™×œ×”/×¤××¨×¦'×× ×˜ ×œ×’×‘×•×œ - ×—×•× ×¢××•×§ ×•×¦×œ ×¢×“×™×Ÿ */
            box-shadow: 0 5px 20px rgba(120, 53, 15, 0.5); 
            border: 4px solid #78350f; /* Deep Amber/Brown */
        }
    </style>
</head>

<!-- ×¨×§×¢ ×‘×”×™×¨, ×“××•×™ ×¤××¨×¦'×× ×˜/××’×™×œ×” - Stone-100 -->
<body class="bg-stone-100 text-gray-900 p-4 md:p-8">

    <!-- ×›×•×ª×¨×ª ×•×‘×§×¨×™ ×©×œ×™×˜×” - ××¡×’×¨×ª ×¡×¤×¨ ×¢×ª×™×§ - Stone-200 -->
    <header class="mb-8 p-4 bg-stone-200 shadow-lg border-b-4 border-amber-900">
        <div class="flex justify-between items-center flex-wrap gap-4 mb-4">
            <!-- H1: ×¦×‘×¢ ×“×™×• ×¢××•×§ (Sepia) -->
            <h1 class="text-3xl font-bold text-amber-900">×§×•×“×§×¡ ××•× ×—×™ ××©×—×§×™ ×ª×¤×§×™×“×™×</h1>
            
            <!-- ×§×™×©×•×¨ ×œ×“×£ ×”××•×“×•×ª -->
            <a href="about.html" class="inline-block px-4 py-2 bg-amber-800 text-white text-lg font-bold rounded-sm shadow-md hover:bg-amber-900 transition duration-300 transform hover:scale-[1.01] whitespace-nowrap">
                ××•×“×•×ª ×”×¤×¨×•×™×§×˜ â†’
            </a>
        </div>
        
        <div class="flex flex-col md:flex-row gap-4">
            <!-- ××–×•×¨ ×—×™×¤×•×© - ×’×‘×•×œ ×—×•× ×—×–×§ -->
            <input type="text" id="search-input" placeholder="×—×¤×© ××™×œ×”..."
                   class="flex-1 p-3 border-2 border-amber-900 bg-white text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-4 focus:ring-amber-700 transition duration-150 rounded-sm">
            
            <!-- ××–×•×¨ ×¡×™× ×•×Ÿ ×œ×¤×™ ×ª×’×™×ª - ×’×‘×•×œ ×—×•× ×—×–×§ -->
            <select id="tag-filter"
                    class="p-3 border-2 border-amber-900 bg-white text-gray-900 focus:outline-none focus:ring-4 focus:ring-amber-700 transition duration-150 rounded-sm">
                <option value="" class="bg-white">×›×œ ×”× ×•×©××™×</option>
                <!-- ××¤×©×¨×•×™×•×ª ×™×˜×¢× ×• ×¢"×™ JS -->
            </select>
        </div>
    </header>
    
    <!-- ×¨×©×ª ×”××™×œ×•×Ÿ ×”×¨×¡×¤×•× ×¡×™×‘×™×ª -->
    <main id="dictionary-grid" class="grid grid-cols-1 sm:grid-cols-3 lg:grid-cols-4 gap-6">
        <!-- ×”××©×‘×¦×•×ª ×™×˜×¢× ×• ×œ×›××Ÿ ×¢"×™ JavaScript -->
    </main>
    
    <!-- ×”×•×“×¢×ª ×˜×¢×™× ×”/××™×Ÿ ×ª×•×¦××•×ª - ×˜×§×¡×˜ ×‘×¦×‘×¢ ×“×™×• ×—×–×§ -->
    <p id="loading-message" class="text-center text-lg text-amber-900 mt-12">×˜×•×¢×Ÿ × ×ª×•× ×™× ×§×¨×™×˜×™×™×...</p>
    <!-- ×”×•×“×¢×ª ×©×’×™××” ×‘××“×•× ××¢×•××¢× -->
    <p id="no-results-message" class="text-center text-lg text-red-700 mt-12 hidden">ğŸ˜” ×œ× × ××¦××• ×¨×©×•××•×ª ×ª×•×××•×ª ×œ×§×•×“×§×¡ ×”× ×ª×•× ×™×.</p>
    
    <!-- --- ×—×œ×•×Ÿ ×§×•×¤×¥ (Modal) - ×¢×™×¦×•×‘ ×‘×”×™×¨ ×•×××•×¡×’×¨ --- -->
    <div id="word-modal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 p-4 hidden">
        <!-- ×¨×§×¢ × ×§×™ ×™×•×ª×¨ ×‘××•×“×œ - Stone-50 -->
        <div class="modal-content bg-stone-50 w-full max-w-2xl rounded-sm shadow-2xl p-6 transition-all transform scale-100">
            <div class="flex justify-between items-start border-b border-amber-900 pb-3 mb-4">
                <!-- ×›×•×ª×¨×ª ××•×“×œ - ×¦×‘×¢ ×“×™×• ×¢××•×§ -->
                <h2 id="modal-title" class="text-3xl font-bold text-amber-900"></h2>
                <button id="close-modal" class="text-gray-600 hover:text-amber-900 text-3xl font-light leading-none pr-2 transition duration-200">
                    &times;
                </button>
            </div>
            <div id="modal-body">
                <!-- ×ª×•×›×Ÿ ×”××™×œ×” ×”××œ× ×™×•×›× ×¡ ×œ×›××Ÿ -->
            </div>
        </div>
    </div>
    
    <!-- --- ×¤×•×˜×¨ - ×¨×’×œ ×”××¡××š --- -->
    <footer class="mt-12 pt-4 border-t-2 border-amber-900 bg-stone-200 text-center text-sm p-4 rounded-t-sm space-y-1">
        <p class="text-amber-900">
            ×× ×•×”×œ ×¢"×™ <a href="https://rrpg.top" target="_blank" class="font-bold text-amber-700 hover:text-amber-900 underline transition">×’×œ×’×•×œ - ××©×—×§×™ ×ª×¤×§×™×“×™× ×œ××¢×Ÿ ×”×§×”×™×œ×”</a>
        </p>
        <p class="text-amber-900">
            ×¤×•×ª×— ×¢"×™ <a href="https://lp.reuven.click" target="_blank" class="font-bold text-amber-700 hover:text-amber-900 underline transition">×¨××•×‘×Ÿ ×× ×“×œ×•×‘×™×¥'</a>
        </p>
    </footer>

    <!-- JavaScript ×œ× ×™×”×•×œ ×”×œ×•×’×™×§×”, ×”×—×™×¤×•×©, ×”×¡×™× ×•×Ÿ ×•×”×§×™×©×•×¨ ×”×¢××•×§ -->
    <script>
        // --- × ×ª×•× ×™ ×”××™×œ×•×Ÿ (JSON) - ×™×™×˜×¢× ×• ×œ×›××Ÿ ---        
        let dictionaryData = []; 

        // --- ×§×‘×•×¢×™× ×•××©×ª× ×™× ×’×œ×•×‘×œ×™×™× ---
        const gridContainer = document.getElementById('dictionary-grid');
        const searchInput = document.getElementById('search-input');
        const tagFilter = document.getElementById('tag-filter');
        const modal = document.getElementById('word-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const closeButton = document.getElementById('close-modal');
        const loadingMessage = document.getElementById('loading-message');
        const noResultsMessage = document.getElementById('no-results-message');
        
        const HEBREW_DETAILS_MAP = {
            gender: "××™×Ÿ",
            binyan: "×‘× ×™×™×Ÿ",
            root: "×©×•×¨×©",
            inflection: "× ×˜×™×™×”",
            verbInflection: "× ×˜×™×™×ª ×”×¤×•×¢×œ"
        };
        const MAX_PREVIEW_LENGTH = 100;         
        const MAX_VISIBLE_TAGS = 3; 

        // --- ×¤×•× ×§×¦×™×•×ª ×œ×˜×™×¤×•×œ ×‘-URL (×§×™×“×•×“ ×•×¤×¢× ×•×—) ---
        function encodeWord(word) {
            return encodeURIComponent(word);
        }
        
        function decodeWord(encodedWord) {
            try {
                return decodeURIComponent(encodedWord);
            } catch (e) {
                console.error("Failed to decode URI component:", encodedWord, e);
                return '';
            }
        }
        
        // --- ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ---
        function truncateText(text, maxLength = MAX_PREVIEW_LENGTH) {
            if (text.length <= maxLength) {
                return text;
            }
            return text.substring(0, maxLength).trim() + '...';
        }

        /**
         * ×‘×•× ×” ××ª ×§×•×“ ×”-HTML ×©×œ ××©×‘×¦×ª ××™×œ×” (Card).
         * @param {Object} item - ××•×‘×™×™×§×˜ ×”××™×œ×” ××”××™×œ×•×Ÿ.
         * @returns {string} - ××—×¨×•×–×ª HTML ×©×œ ×”××©×‘×¦×ª.
         */
        function createCardHtml(item) {
            const cardId = encodeWord(item.word); 
            const definitionPreview = truncateText(item.definition);
            const visibleTags = item.tags.slice(0, MAX_VISIBLE_TAGS);
            const extraTagsCount = item.tags.length - MAX_VISIBLE_TAGS;

            let tagsHtml = visibleTags.map(tag =>
                `<span class="tag inline-block bg-red-900/10 text-red-700 text-xs font-medium px-2.5 py-0.5 rounded-sm ml-2 whitespace-nowrap border border-red-900/50">${tag}</span>`
            ).join('');

            if (extraTagsCount > 0) {
                tagsHtml += `<span class="tag inline-block bg-stone-200 text-gray-700 text-xs font-medium px-2.5 py-0.5 rounded-sm ml-2 whitespace-nowrap border border-stone-300">+${extraTagsCount}</span>`;
            }

            // ×¢×™×¦×•×‘ ×›×¨×˜×™×¡: ×¨×§×¢ ×¤××¨×¦'×× ×˜ ×× ×•×˜×¨×œ (stone-50), ×’×‘×•×œ ×—×–×§, ×¦×œ ×¢×“×™×Ÿ ×“××•×™ ×¢×•××§
            return `
                <div data-id="${cardId}" 
                     data-tags="${item.tags.join(' ')}" 
                     class="word-card bg-stone-50 p-5 border-2 border-amber-900 rounded-sm shadow-[0_5px_15px_rgba(120,53,15,0.2)] hover:shadow-[0_8px_20px_rgba(120,53,15,0.4)] hover:scale-[1.02] transition transform duration-300 cursor-pointer" 
                     tabindex="0">
                    
                    <!-- ××™×œ×” ×¨××©×™×ª: ×¦×‘×¢ ×“×™×• ×¢××•×§ (Sepia) -->
                    <h2 class="main-word text-2xl font-extrabold text-amber-900 mb-2">${item.word}</h2>
                    
                    <div class="tags-list mb-3 flex flex-wrap gap-y-1">
                        ${tagsHtml}
                    </div>

                    <p class="source-en text-base text-gray-600 mb-2 font-medium">××§×•×¨ (EN): ${item.sourceEn}</p>

                    <p class="definition-preview text-base text-gray-800 font-medium">
                        ${definitionPreview}
                    </p>
                </div>
            `;
        }

        /**
         * ××¨× ×“×¨ ××ª ×”××™×œ×™× ×”× ×•×›×—×™×•×ª ×‘-Grid.
         * @param {Array} data - ××¢×¨×š ×”××™×œ×™× ×œ×”×¦×’×”.
         */
        function renderCards(data) {
            gridContainer.innerHTML = data.map(createCardHtml).join('');

            if (data.length === 0) {
                noResultsMessage.classList.remove('hidden');
            } else {
                noResultsMessage.classList.add('hidden');
            }

            // ×”×•×¡×¤×ª Event Listeners ×œ×›×œ ××©×‘×¦×ª ×—×“×©×”
            document.querySelectorAll('.word-card').forEach(card => {
                card.addEventListener('click', () => openModal(card.dataset.id));
                card.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        openModal(card.dataset.id);
                    }
                });
            });
        }

        /**
         * ×¤×•×ª×— ××ª ×”×—×œ×•×Ÿ ×”×§×•×¤×¥ ×•××¢×“×›×Ÿ ××ª ×”-URL (Hash).
         * @param {string} encodedWordId - ×”××™×œ×” ×”××§×•×“×“×ª (×›×¤×™ ×©××•×¤×™×¢×” ×‘-data-id).
         */
        function openModal(encodedWordId) {
            const wordToFind = decodeWord(encodedWordId); 
            // ×—×™×¤×•×© ×‘××•×¡×£ ×”× ×ª×•× ×™× ×”×’×œ×•×‘×œ×™ ×”×˜×¢×•×Ÿ
            const word = dictionaryData.find(item => item.word === wordToFind); 
            if (!word) return;

            // 1. ×¢×“×›×•×Ÿ ×”-URL (Deep Linking) ×‘×××¦×¢×•×ª Hash (#)
            if (window.location.hash.substring(1) !== encodedWordId) {
                window.location.hash = `#${encodedWordId}`;
            }

            // 2. ×‘× ×™×™×ª ×ª×•×›×Ÿ ×”×—×œ×•×Ÿ ×”×§×•×¤×¥
            modalTitle.textContent = word.word;

            // ×‘× ×™×™×ª ×˜×‘×œ×ª ×¤×¨×˜×™× ××œ××” 
            let fullDetailsTable = Object.keys(HEBREW_DETAILS_MAP)
                .map(key => ({
                    label: HEBREW_DETAILS_MAP[key],
                    value: word.hebrewDetails[key]
                }))
                .filter(detail => detail.value && detail.value.trim() !== '××™×Ÿ');

            // ×‘× ×™×™×ª ×›×œ ×”×ª×’×™×•×ª 
            const allTagsHtml = word.tags.map(tag =>
                `<span class="tag inline-block bg-red-900/10 text-red-700 text-sm font-medium px-3 py-1 rounded-sm ml-2 border border-red-900/50">${tag}</span>`
            ).join('');

            // ×§×œ××¡×™× ×‘×”×™×¨×™× ×¢×‘×•×¨ ×”××•×“×œ
            const fullDetailsHtml = `
                <div class="tags-list mb-4 flex flex-wrap gap-y-1">
                    ${allTagsHtml}
                </div>

                <p class="source-en text-sm text-gray-600 mb-4">××§×•×¨ ×‘×× ×’×œ×™×ª: <span class="font-semibold">${word.sourceEn}</span></p>

                <!-- ×¤×™×¨×•×˜ ×¢×‘×¨×™ ××œ× - ××•×¦×’ ×¨×§ ×‘××•×“×œ -->
                ${fullDetailsTable.length > 0 ? `
                    <!-- ×›×•×ª×¨×ª: ×¦×‘×¢ ×“×™×• ×¢××•×§ -->
                    <h3 class="text-xl font-semibold mt-4 mb-2 border-b border-amber-900 pb-1 text-amber-900">×¤×™×¨×•×˜ ×œ×©×•× ×™ (×¢×‘×¨×™):</h3>
                    <table class="w-full text-base text-gray-700">
                        <tbody>
                            ${fullDetailsTable.map(d => `
                                <tr class="border-b border-stone-300 last:border-b-0">
                                    <th class="py-1 pr-0 font-bold w-1/3 text-right text-amber-900">${d.label}:</th>
                                    <td class="py-1 pl-0 font-normal w-2/3 text-right">${d.value}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                ` : ''}

                <!-- ×›×•×ª×¨×ª: ×¦×‘×¢ ×“×™×• ×¢××•×§ -->
                <h3 class="text-xl font-semibold mt-6 mb-2 border-b border-amber-900 pb-1 text-amber-900">×¤×™×¨×•×© ××œ×:</h3>
                <p class="text-lg mb-6 leading-relaxed text-gray-800">${word.definition}</p>

                <!-- ×›×•×ª×¨×ª: ×¦×‘×¢ ×“×™×• ×¢××•×§ -->
                <h3 class="text-xl font-semibold mt-6 mb-2 border-b border-amber-900 pb-1 text-amber-900">×©×™××•×©×™× ×•×“×•×’×××•×ª:</h3>
                <ul class="list-disc pr-5 space-y-2 text-gray-800">
                    ${word.usages.map(u => `<li>${u}</li>`).join('')}
                </ul>
            `;
            modalBody.innerHTML = fullDetailsHtml;

            // 3. ×”×¦×’×ª ×”×—×œ×•×Ÿ ×”×§×•×¤×¥
            modal.classList.remove('hidden');
        }

        /**
         * ×¡×•×’×¨ ××ª ×”×—×œ×•×Ÿ ×”×§×•×¤×¥ ×•××¢×“×›×Ÿ ××ª ×”-URL ×œ×‘×¡×™×¡.
         */
        function closeModal() {
            modal.classList.add('hidden');
            // ×”×¡×¨×ª ×”×¤×¨××˜×¨ ××”-URL ×‘×××¦×¢×•×ª Hash
            window.location.hash = '';
        }

        /**
         * ××¤×¢×™×œ ××ª ×”×—×™×¤×•×© ×•×”×¡×™× ×•×Ÿ ×¢×œ ×›×œ ×”× ×ª×•× ×™× ×”×˜×¢×•× ×™×.
         */
        function applyFilters() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            const selectedTag = tagFilter.value;

            const filteredData = dictionaryData.filter(item => {
                if (!item || !item.word) return false;

                // 1. ×¡×™× ×•×Ÿ ×—×™×¤×•×© ×˜×§×¡×˜
                const searchMatch = item.word.toLowerCase().includes(searchTerm) ||
                                    item.definition.toLowerCase().includes(searchTerm) ||
                                    item.sourceEn.toLowerCase().includes(searchTerm);

                // 2. ×¡×™× ×•×Ÿ ×ª×’×™×•×ª
                const tagMatch = !selectedTag || item.tags.includes(selectedTag);

                return searchMatch && tagMatch;
            });
            renderCards(filteredData);
        }

        /**
         * ×˜×•×¢×Ÿ ××ª ×›×œ ×”×ª×’×™×•×ª ×”×™×™×—×•×“×™×•×ª ×•××›× ×™×¡ ××•×ª×Ÿ ×œ×ª×™×‘×ª ×”×‘×—×™×¨×”.
         */
        function populateTags() {
            const allTags = dictionaryData.flatMap(item => item.tags || []); // ×œ×•×•×“× ×©×“×•×ª ×§×™×™××™×
            const uniqueTags = [...new Set(allTags)].sort();

            const optionsHtml = uniqueTags.map(tag =>
                `<option value="${tag}" class="bg-white">${tag}</option>`
            ).join('');

            // ××©××¨ ××ª ×”××¤×©×¨×•×ª "×›×œ ×”× ×•×©××™×"
            tagFilter.innerHTML = `<option value="" class="bg-white">×›×œ ×”× ×•×©××™×</option>` + optionsHtml;
        }

        /**
         * ×‘×•×“×§ ×× ×™×© ×¤×¨××˜×¨ ××™×œ×” ×‘-URL ×•×¤×•×ª×— ××ª ×”×—×œ×•×Ÿ ×”×§×•×¤×¥ ×‘×”×ª××.
         */
        function checkUrlForWord() {
            const encodedWordId = window.location.hash.substring(1); 
            if (encodedWordId) {
                // ×©×™××•×© ×‘-setTimeout ×§×¦×¨ ×›×“×™ ×œ×•×•×“× ×©×›×œ ×”××œ×× ×˜×™× ×¨× ×“×¨×• ×œ×¤× ×™ ×¤×ª×™×—×ª ×”××•×“×œ
                setTimeout(() => openModal(encodedWordId), 100);
            }
        }

        /**
         * ×¤×•× ×§×¦×™×™×ª ×”×˜×¢×™× ×” ×”×¨××©×™×ª - ×§×•×¨××ª ××ª ×”-JSON ×•××¤×¢×™×œ×” ××ª ×”×œ×•×’×™×§×”
         */
        window.onload = async function() {
            // --- ×©×œ×‘ 1: ×˜×¢×™× ×ª ×”× ×ª×•× ×™× ×-JSON ---
            try {
                const response = await fetch('terms.json');
                if (!response.ok) throw new Error('Failed to load terms.json');
                
                dictionaryData = await response.json();
                loadingMessage.classList.add('hidden'); // ×”×¡×ª×¨×ª ×”×•×“×¢×ª ×”×˜×¢×™× ×”
                
            } catch (error) {
                console.error("Error loading dictionary data:", error);
                loadingMessage.textContent = '××™×¨×¢×” ×©×’×™××” ×§×¨×™×˜×™×ª ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ×”××™×œ×•×Ÿ.';
                loadingMessage.classList.remove('hidden');
                loadingMessage.classList.add('text-red-700', 'font-bold');
                return; // ×”×¤×¡×§×ª ×”××ª×—×•×œ
            }

            // --- ×©×œ×‘ 2: ×”×¤×¢×œ×ª ×”×œ×•×’×™×§×” ×”××§×•×¨×™×ª ---
            populateTags();
            renderCards(dictionaryData);
            checkUrlForWord();

            // 5. ×”×•×¡×¤×ª ×××–×™× ×™× ×œ×¤×§×“×™ ×”×©×œ×™×˜×”
            searchInput.addEventListener('input', applyFilters);
            tagFilter.addEventListener('change', applyFilters);
            closeButton.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });

            // 6. ×˜×™×¤×•×œ ×‘×›×¤×ª×•×¨ "××—×•×¨×”" ×‘×“×¤×“×¤×Ÿ (Browser Back Button)
            window.addEventListener('popstate', (e) => {
                const encodedWordId = window.location.hash.substring(1);

                if (encodedWordId) {
                    openModal(encodedWordId);
                } else {
                    if (!modal.classList.contains('hidden')) { 
                         modal.classList.add('hidden');
                    }
                }
            });
        };
    </script>
</body>
</html>
